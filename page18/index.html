
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@yorzi</title>
  <meta name="author" content="Andy Wang">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.wangyaodi.com/page18/index.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <link href="/atom.xml" rel="alternate" title="@yorzi" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11967621-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  

  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/" style="color:red">@yorzi</a></h1>
  
  <a href="https://github.com/yorzi/life_blog"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/images/forkme.png" alt="Fork me on GitHub"></a>
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="wangyaodi@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:blog.wangyaodi.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="http://tech.wangyaodi.com">技术闲谈</a></li>
  <li><a href="http://about.me/wangyaodi">关于安迪</a></li>
  <li><a href="/blog/archives">博客存档</a></li>
  <li><a href="https://plus.google.com/108320517625960982177/about?hl=en" style="color:red">@yorzi</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/19/erlang/">Erlang</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-19 00:00:00 +0800" pubdate  updated >Nov 19<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>本篇是完全转载的一篇文章，<a href="http://www.dujingfang.com">7哥</a>昨天利用这个例子给team讲了一下erlang，在这里做个备份，免得以后要用时候找不到了。<a href="http://erlang-china.org/start/mochiweb_intro.html">原文链接</a></p>




<p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;
<a href="http://code.google.com/p/mochiweb" target="_blank">MochiWeb</a>是<a href="http://www.mochibot.com/" target="_blank">mochibot.com</a>的<a href="http://bob.pythonmac.org/" target="_blank">Bob Ippolito</a>贡献的开源项目[在<a href="http://undefined.org/c4-1/" target="_blank">这里</a>有一个介绍它的Slide]。</p>




<p>MochiBot.com 提供 Flash 内容的访问统计和用户跟踪服务（大致上，可以理解为针对 flash 的 google Analytics 服务），他们在 mochiweb 之上构建了一个定制化的 web server ，并通过这个 web server 获取用户的访问数据（在这一点上有点象 <a href="http://code.google.com/p/erlana/" target="_blank">Erlana</a> 项目）。可以想象，这个定制的 web server 需要很高的并发支持，精简和牢固的底层架构，以及对于 http 协议的完备支持（乃至对于 socket 的直接操控）。如果可以的话，最好还有更为精简的 API ，易于定制的 URL 扩展方式，以及易于理解的底层框架。幸运的是，这些 mochiweb 都已经提供，而且还是开源的。</p>




<p>需要说明的是，相比 yaws / inets httpd 而言，它的目标并不是 apache 之类的软件，它并不是一个完整的 web server （没有cache等机制，因而也不做任何加速动作），它只是一个实现 web server 的工具包（这也就意味着，它直接通过代码来扩展，你可以在它的基础上做任何事）。正因为此，在“需要定制 Web Server”的情况下，它成为一个非常不错的选择（比如，配置在 enginx 的后面，专门用于动态内容的生成）。在 erlang 的世界里，有几个项目已经开始转而使用 mochiweb 。</p>




<p>下面是对这个项目代码的一些粗浅实战。</p>




<p>首先遵循它的提示，通过svn获取代码：
<div>
<div>svn checkout http://mochiweb.googlecode.com/svn/trunk/ mochiweb-read-only</div>
</div>
获得的文件和目录结构如下：
<div>
<div>deps  ebin     LICENSE   priv    scripts  support<br />
doc   include  Makefile  README  src</div>
</div>
注：大写字母开头的是文件，小写字母开头的是目录。这是一个相当标准的 Erlang 项目目录结构，其 Makefile （用到 support 目录的 make 包含文件）非常值得借鉴（而且也有简化这一借鉴步骤的办法，后面会提到）。</p>




<p>这是一个纯粹的 Erlang 项目，并不涉及其它语言写的模块，照老规矩，直接 make ：
<div>
<div>make</div>
</div>
注：如果你和我一样，仍在 R11* 上工作，那么 make 会在 edoc 的步骤中失败，这是因为 R11* 的 edoc 工具存在 bug 无法正确处理 mochiweb 用到的<a href="http://erlang-china.org/study/parameterized-module.html" target="_blank"> Parameterized module 语法</a>，不用管它，并不影响后续使用。</p>




<p>make 完成之后，要怎么试运行呢？这就涉及我们上面提到的“借鉴”工作。因为 mochiweb 是设计用来作为一个完整项目的一个基础部分，也就是说，它只是一个骨架（或者如作者所说的toolkit），在你 make 完之后，什么也干不了，除非你对它进行定制化编码，完成这个 web server 。好在它自己已经提供了工具来简化这一步骤：
<div>
<div>escript scripts/new_mochiweb.erl test</div>
</div>
new_mochiweb.erl 是一个 EScript 脚本，它负责从 mochiweb 中拷贝使用 mochiweb 所必须文件和目录，形成你的新项目的“骨架”（概念上有点类似于 rails 的自动生成代码）。上面的命令生成了名为 test 的项目，会在当前目录建立名为 test 子目录（还可以使用 escript scripts/new_mochiweb.erl test testdir 将新建立的项目放在 testdir 目录中）。上面的命令生成了一些文件，我加了注释：
<div>
<div>./test/            项目目录<br />
Makefile        Make文件<br />
start.sh        启动脚本<br />
start-dev.sh    开发模式下的启动脚本（开启代码重载机制）<br />
./test/ebin/        编译目录<br />
./test/support/     Make支持文件目录<br />
include.mk      Make包含脚本<br />
./test/deps/        依赖目录，包含mochiweb自身<br />
./test/src/     代码目录<br />
skel.app        实际名称为test.app，OTP规范的应用定义文件<br />
Makefile        Make文件<br />
skel_web.erl    实际名称为test_web.erl，应用的web服务器代码<br />
skel_deps.erl   实际名称为test_deps.erl，负责加载deps目录的代码<br />
skel_sup.erl    实际名称为test_sup.erl，OTP规范的监控树<br />
skel.hrl        实际名称为test.hrl，应用的头文件<br />
skel_app.erl    实际名称为test_app.erl，OTP规范的应用启动文件<br />
skel.erl        实际名称为test.erl，应用的API定义文件<br />
./test/doc/     文档目录<br />
./test/include/     包含文件目录<br />
./test/priv/        项目附加目录<br />
./test/priv/www/    项目附加的www目录<br />
index.html      默认的项目首页</div>
</div>
是的，什么也不用改，在新生成的项目骨架中，一个可用的web服务器已经就绪：
<div>
<div>make<br />
./start-dev.sh</div>
</div>
这会打开一个 erlang shell ，输出的信息表明在 8000 端口开了一个 web 服务，此时用浏览器访问 http://localhost:8000 （或者其它正确的地址）就能看到“MochiWeb running.”，这表明 mochiweb 配置正确，运行良好。注意，我们上面是用 start-dev.sh 来启动的，它打开了 reloader 特性。</p>




<p>现在修改一下 test_web.erl 的代码，加点料。因为我们上面已经打开了 reloader 所以，不用关掉这个 erlang shell ，我们可以直接修改和编译，然后刷新就能看到效果（有点 PHP 编程的意思了）。把 test_web.erl 改成这样，看看会有什么情况发生：
<div>下载: <a href="http://erlang-china.org/wordpress/wp-content/plugins/coolcode/coolcode.php?p=151&amp;download=test_web.erl">test_web.erl</a></div>
<div>
<ol title="Double click to hide line number." ondblclick="linenumber(this)">
    <li><span style="color: #ffa500;">%% @author author &lt;author@example.com&gt;</span></li>
    <li><span style="color: #ffa500;">%% @copyright YYYY author.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: #ffa500;">%% @doc Web server for test.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Gray;">-</span><span style="color: Blue;">module</span><span style="color: Olive;">(</span><span style="color: Blue;">test_web</span><span style="color: Olive;">)</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;">-</span><span style="color: Blue;">author</span><span style="color: Olive;">(</span><span style="color: #8b0000;">&#8217;</span><span style="color: Red;">author &lt;author@example.com&gt;</span><span style="color: #8b0000;">&#8217;</span><span style="color: Olive;">)</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Gray;">-</span><span style="color: Blue;">export</span><span style="color: Olive;">([</span><span style="color: Blue;">start</span><span style="color: Gray;">/</span><span style="color: Maroon;">1</span><span style="color: Gray;">, </span><span style="color: Blue;">stop</span><span style="color: Gray;">/</span><span style="color: Maroon;">0</span><span style="color: Gray;">, </span><span style="color: Blue;">loop</span><span style="color: Gray;">/</span><span style="color: Maroon;">2</span><span style="color: Olive;">])</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: #ffa500;">%% External API</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Blue;">start</span><span style="color: Olive;">(</span><span style="color: Blue;">Options</span><span style="color: Olive;">)</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> {</span><span style="color: Blue;">DocRoot</span><span style="color: Gray;">, </span><span style="color: Blue;">Options1</span><span style="color: Gray;">} = </span><span style="color: Blue;">get_option</span><span style="color: Olive;">(</span><span style="color: Blue;">docroot</span><span style="color: Gray;">, </span><span style="color: Blue;">Options</span><span style="color: Olive;">)</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Loop</span><span style="color: Gray;"> = </span><span style="color: Green;">fun</span><span style="color: Gray;"> </span><span style="color: Olive;">(</span><span style="color: Blue;">Req</span><span style="color: Olive;">)</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> ?</span><span style="color: Blue;">MODULE</span><span style="color: Gray;">:</span><span style="color: Blue;">loop</span><span style="color: Olive;">(</span><span style="color: Blue;">Req</span><span style="color: Gray;">, </span><span style="color: Blue;">DocRoot</span><span style="color: Olive;">)</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">end</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">mochiweb_http</span><span style="color: Gray;">:</span><span style="color: Blue;">start</span><span style="color: Olive;">([</span><span style="color: Gray;">{</span><span style="color: Blue;">name</span><span style="color: Gray;">, ?</span><span style="color: Blue;">MODULE</span><span style="color: Gray;">}, {</span><span style="color: Blue;">loop</span><span style="color: Gray;">, </span><span style="color: Blue;">Loop</span><span style="color: Gray;">} | </span><span style="color: Blue;">Options1</span><span style="color: Olive;">])</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Blue;">stop</span><span style="color: Olive;">()</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">mochiweb_http</span><span style="color: Gray;">:</span><span style="color: Blue;">stop</span><span style="color: Olive;">(</span><span style="color: Gray;">?</span><span style="color: Blue;">MODULE</span><span style="color: Olive;">)</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Blue;">loop</span><span style="color: Olive;">(</span><span style="color: Blue;">Req</span><span style="color: Gray;">, </span><span style="color: Blue;">DocRoot</span><span style="color: Olive;">)</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: #8b0000;">&#8220;</span><span style="color: Red;">/</span><span style="color: #8b0000;">&#8221;</span><span style="color: Gray;"> ++ </span><span style="color: Blue;">Path</span><span style="color: Gray;"> = </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">get</span><span style="color: Olive;">(</span><span style="color: Blue;">path</span><span style="color: Olive;">)</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">case</span><span style="color: Gray;"> </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">get</span><span style="color: Olive;">(</span><span style="color: Blue;">method</span><span style="color: Olive;">)</span><span style="color: Gray;"> </span><span style="color: Green;">of</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Method</span><span style="color: Gray;"> </span><span style="color: Green;">when</span><span style="color: Gray;"> </span><span style="color: Blue;">Method</span><span style="color: Gray;"> =:= </span><span style="color: #8b0000;">&#8216;</span><span style="color: Red;">GET</span><span style="color: #8b0000;">&#8217;</span><span style="color: Gray;">; </span><span style="color: Blue;">Method</span><span style="color: Gray;"> =:= </span><span style="color: #8b0000;">&#8216;</span><span style="color: Red;">HEAD</span><span style="color: #8b0000;">&#8217;</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">case</span><span style="color: Gray;"> </span><span style="color: Blue;">Path</span><span style="color: Gray;"> </span><span style="color: Green;">of</span></li>
    <li><span style="color: Gray;"> </span><span style="color: #8b0000;">&#8220;</span><span style="color: Red;">timer</span><span style="color: #8b0000;">&#8221;</span><span style="color: Gray;"> -&gt; </span><span style="color: #ffa500;">%% 新增了 /timer 这个 URL，它是一个 HTTP Chunked 的例子</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Response</span><span style="color: Gray;"> = </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">ok</span><span style="color: Olive;">(</span><span style="color: Gray;">{</span><span style="color: #8b0000;">&#8221;</span><span style="color: Red;">text/plain</span><span style="color: #8b0000;">&#8221;</span><span style="color: Gray;">, </span><span style="color: Blue;">chunked</span><span style="color: Gray;">}</span><span style="color: Olive;">)</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">timer</span><span style="color: Olive;">(</span><span style="color: Blue;">Response</span><span style="color: Olive;">)</span><span style="color: Gray;">;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">_</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">serve_file</span><span style="color: Olive;">(</span><span style="color: Blue;">Path</span><span style="color: Gray;">, </span><span style="color: Blue;">DocRoot</span><span style="color: Olive;">)</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">end</span><span style="color: Gray;">;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: #8b0000;">&#8216;</span><span style="color: Red;">POST</span><span style="color: #8b0000;">&#8217;</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">case</span><span style="color: Gray;"> </span><span style="color: Blue;">Path</span><span style="color: Gray;"> </span><span style="color: Green;">of</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">_</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">not_found</span><span style="color: Olive;">()</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">end</span><span style="color: Gray;">;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">_</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Req</span><span style="color: Gray;">:</span><span style="color: Blue;">respond</span><span style="color: Olive;">(</span><span style="color: Gray;">{</span><span style="color: Maroon;">501</span><span style="color: Gray;">, </span><span style="color: Olive;">[]</span><span style="color: Gray;">, </span><span style="color: Olive;">[]</span><span style="color: Gray;">}</span><span style="color: Olive;">)</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Green;">end</span><span style="color: Gray;">.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: #ffa500;">%% Internal API</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: Blue;">get_option</span><span style="color: Olive;">(</span><span style="color: Blue;">Option</span><span style="color: Gray;">, </span><span style="color: Blue;">Options</span><span style="color: Olive;">)</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> {</span><span style="color: Blue;">proplists</span><span style="color: Gray;">:</span><span style="color: Blue;">get_value</span><span style="color: Olive;">(</span><span style="color: Blue;">Option</span><span style="color: Gray;">, </span><span style="color: Blue;">Options</span><span style="color: Olive;">)</span><span style="color: Gray;">, </span><span style="color: Blue;">proplists</span><span style="color: Gray;">:</span><span style="color: Blue;">delete</span><span style="color: Olive;">(</span><span style="color: Blue;">Option</span><span style="color: Gray;">, </span><span style="color: Blue;">Options</span><span style="color: Olive;">)</span><span style="color: Gray;">}.</span></li>
    <li><span style="color: Gray;"> </span></li>
    <li><span style="color: #ffa500;">%% 打印当前时间，间隔一秒，再在已经打开的 http 连接之上，再次打印，这也就是所谓 HTTP长连接/ServerPush 的一种</span></li>
    <li><span style="color: Blue;">timer</span><span style="color: Olive;">(</span><span style="color: Blue;">Response</span><span style="color: Olive;">)</span><span style="color: Gray;"> -&gt;</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">Response</span><span style="color: Gray;">:</span><span style="color: Blue;">write_chunk</span><span style="color: Olive;">(</span><span style="color: Blue;">io_lib</span><span style="color: Gray;">:</span><span style="color: Blue;">format</span><span style="color: Olive;">(</span><span style="color: #8b0000;">&#8221;</span><span style="color: Red;">The time is: ~p~n</span><span style="color: #8b0000;">&#8221;</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Olive;">[</span><span style="color: Blue;">calendar</span><span style="color: Gray;">:</span><span style="color: Blue;">local_time</span><span style="color: Olive;">()]))</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">timer</span><span style="color: Gray;">:</span><span style="color: Blue;">sleep</span><span style="color: Olive;">(</span><span style="color: Maroon;">1000</span><span style="color: Olive;">)</span><span style="color: Gray;">,</span></li>
    <li><span style="color: Gray;"> </span><span style="color: Blue;">timer</span><span style="color: Olive;">(</span><span style="color: Blue;">Response</span><span style="color: Olive;">)</span><span style="color: Gray;">.</span></li>
</ol>
</div>
编译之前，先访问一下 http://localhost:8000/timer ，是“Not found.”。此时，不要中断之前的 erlang shell 而是直接再次 make ：
<div>
<div>make</div>
</div>
留意到之前打开的 erlang shell 上出现了这么一行：
<div>
<div>1&gt; Reloading test_web &#8230; ok.</div>
</div>
此时，再次访问 http://localhost:8000/timer （耐心些 HTTP chunked 获得的数据要积累到一定的字节浏览器才会显示），你会发现这是一个不会“下载结束”的页面，不断会有新的内容出现在下面。你也许可以利用这个特性实现传说 中的“无刷新聊天室”。</p>




<p>值得留意的是这样的代码：
<div>
<div>&#8230;<br />
Req:ok({&#8220;text/plain&#8221;, chunked}),<br />
&#8230;<br />
Req:serve_file(Path, DocRoot)<br />
&#8230;<br />
Response:write_chunk(io_lib:format(&#8220;The time is: ~p~n&#8221;,<br />
[calendar:local_time()])),<br />
&#8230;</div>
</div>
我们这里是用 Req:ok(…) 而不是 request:ok(Req, …) 这在 Erlang 的代码中并不寻常，Req 是一个变量，通常这个变量的值是某个 atom 表明的是一个 module 的名称，但这里的 Req 显然不是这样。它是一个 “module 的实例”，这就是我们前面提到的“<a href="http://erlang-china.org/study/parameterized-module.html" target="_blank"> Parameterized module 语法</a>”的实际应用，它不仅意味着某个模块的名称，还意味着(初始化时)传给这个模块的一系列参数，它包装了与一个 request 相关的数据。应该说，这个语法更加简洁易懂。</p>




<p>问题：</p>




<p>1. 如果在此时，并不关闭正在不断“下载页面”的浏览器，在 test_web.erl 中将 timer 的部分注释掉，然后再次 make ，会发生什么？为什么？<br />
2. 找出 Req 在 mochiweb 的哪个模块中被初始化？如何被初始化？它实际上是由哪个模块来实现的？<br />
3. 解释 test_web.erl 的代码结构，各个部分都起什么作用？它是如何服务于每一个请求的？<br />
4. 如何在 test_web.erl 中直接访问 http 连接的 socket ？</p>




<p>（实际上，这个例子只是一个 HTTP Chunked 的例子而已，你并不能依赖于 HTTP Chunked 来实现聊天室，这不是 HTTP Chunked 的问题，而是因为在现实的网络环境下，路由器有可能会自动断开连接时长超过某个值的连接。）</p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/19/erlang/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/17/ui-framework/">UI Framework</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-17 00:00:00 +0800" pubdate  updated >Nov 17<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>最近发现了几个UI framework，接下来我要把他们和RoR优美的结合起来，这样以来，在做什么应用的时候，就不愁没有Style了。</p>




<p>1. 一个依赖于JQuery的UI库，很喜欢。<a href="http://jqueryui.com/">http://jqueryui.com/</a></p>




<p>2. 一个依赖于<a title="prototype.js official website" href="http://prototypejs.org/">Prototype</a> 和 <a title="Script.aculo.us official website" href="http://script.aculo.us/">Script.aculo.us</a>的库，也很不错。<a href="http://scripteka.com/">http://scripteka.com/</a></p>




<p>3. 还是一个基于Prototype的UI库<a href="http://livepipe.net/">http://livepipe.net/</a></p>




<p>4. YUI, Google搜索“<a href="http://www.google.com/search?hl=en&client=firefox-a&rls=com.ubuntu%3Aen-US%3Aunofficial&hs=96C&q=UI+framework&btnG=Search&aq=f&oq=&aqi=g-p1g-c3g1g-c5">UI Framework</a>”得到的第一个链接。</p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/17/ui-framework/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/17/jquery-for-rails-developer/">JQuery for Rails Developer</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-17 00:00:00 +0800" pubdate  updated >Nov 17<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p><div style="width:425px;text-align:left" id="__ss_110063"><a style="font:14px Helvetica,Arial,Sans-serif;display:block;margin:12px 0 3px 0;text-decoration:underline;" href="http://www.slideshare.net/wycats/jquery-presentation-to-rails-developers-110063" title="jQuery Presentation to Rails Developers">jQuery Presentation to Rails Developers</a><object style="margin:0px" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=jquery-presentation-to-rails-developers3264&stripped_title=jquery-presentation-to-rails-developers-110063" /><param name="allowFullScreen" value="true" /><param name="allowScriptAccess" value="always" /><embed src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=jquery-presentation-to-rails-developers3264&stripped_title=jquery-presentation-to-rails-developers-110063" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed></object><div style="font-size:11px;font-family:tahoma,arial;height:26px;padding-top:2px;">View more <a style="text-decoration:underline;" href="http://www.slideshare.net/">documents</a> from <a style="text-decoration:underline;" href="http://www.slideshare.net/wycats">Yehuda Katz</a>.</div></div></p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/17/jquery-for-rails-developer/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/16/%E5%8C%97%E4%BA%AC2009-2012%E5%B9%B4%E5%9C%B0%E9%93%81%E8%A7%84%E5%88%92%E5%9B%BE/">北京2009-2012年地铁规划图</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-16 00:00:00 +0800" pubdate  updated >Nov 16<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>如果这个图是可靠的，有些人也可以开始规划他的一部分人生了，比如住房。</p>




<p>[caption id=&#8221;attachment_89&#8221; align=&#8221;aligncenter&#8221; width=&#8221;512&#8221; caption=&#8221;BeiJing Subway Map in 2012&#8221;]<a href="http://blog.wangyaodi.com/wp-content/uploads/2009/11/beijing-subway-2020.jpeg" target="_blank"><img class="size-large wp-image-89" style="border: 2px solid black;" title="beijing-subway-2020" src="http://blog.wangyaodi.com/wp-content/uploads/2009/11/beijing-subway-2020-1024x896.jpg" alt="BeiJing Subway Map in 2020" width="512" height="448" /></a>[/caption] </p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/16/%E5%8C%97%E4%BA%AC2009-2012%E5%B9%B4%E5%9C%B0%E9%93%81%E8%A7%84%E5%88%92%E5%9B%BE/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/15/%E8%89%B2%E9%9F%B3%E5%90%89%E6%97%A5%E5%91%BC/">色音吉日呼</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-15 00:00:00 +0800" pubdate  updated >Nov 15<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>本周最具喜感的收获在于，上课的时候，老师点名，若干出乎意料的人名冒了出来，不得不感慨这些年认识的人里面，竟然没什么人的名字如此有突破，其实这些年一直被朋友开玩笑我的名字，也比较留意别人的名字，名字本来只是一个符号，不用过多的言论，这次权当跟大家普及一个姓氏，另外分享几个这两天听到的名字。万一名字在此文中的同学看到了这篇帖子，千万不要对号入座，我兴许说的不是你。。(其实这回真有点不地道)</p>




<p>一哥们儿名叫：色音吉日呼。<br />
在网上查了一下，“‘色’作为姓氏使用时读作‘shǎi’，而大多数人遇见它都读‘sè’， 据我了解大连姓‘色’的只有我一个呢。”现在在大连某房地产公司做置业顾问的色淼女士老家在吉林白城。色淼的父亲对记者说，在白城共有近30户色姓人家，他们家世代在那居住，属于满族的古老姓氏，“色”姓在当地都被读作“shǎi”。参考连接：<a href="http://news.lnd.com.cn/htm/2008-05/16/content_175599.htm">稀有姓氏</a></p>




<p>另外有个粗犷的哥们儿，名叫“宝宝”。还有两个哥们儿一个叫“裴胖盼”一个叫“马国孬”。</p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/15/%E8%89%B2%E9%9F%B3%E5%90%89%E6%97%A5%E5%91%BC/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/15/%E5%86%8D%E6%AC%A1%E6%94%B9%E7%89%88/">再次改版</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-15 00:00:00 +0800" pubdate  updated >Nov 15<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>有一天我突然发现blog在IE下丑陋的十分严重，就开始琢磨换一个简单的风格，今天晚上花了20分钟，换成现在的样子，有些地方还需要微调一下，让它变得更加简单。</p>




<p>这回摒弃了黑色，尽管我依然对黑色钟情有佳，但是还是觉得黑的有点装，更要命的是，黑色的确会让眼睛有点疲劳，此为正解。</p>




<p>最后，看一看原来的风格在我电脑上面的样子。(顺便说一下，不知道什么时候开始我无比厌恶Windows。)
<p style="text-align: center;"><a href="http://blog.wangyaodi.com/wp-content/uploads/2009/11/blog-v1.png"><img class="aligncenter size-large wp-image-82" title="blog-v1" src="http://blog.wangyaodi.com/wp-content/uploads/2009/11/blog-v1-1024x640.png" alt="blog-v1" width="600" height="320" /></a></p></p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/15/%E5%86%8D%E6%AC%A1%E6%94%B9%E7%89%88/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/13/%E5%9C%A8ror%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">在ROR中执行定时任务</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-13 00:00:00 +0800" pubdate  updated >Nov 13<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>目前最常用的方法是利用Unix自身的<a href="http://en.wikipedia.org/wiki/Cron">cron</a>功能来实现定时任务，但是cron的语法比较麻烦(个人感觉)，今天为了执行一个定时任务发现了一个很好的RubyGem可以让你用Ruby的方式定义定时任务，这就是<a href="http://github.com/javan/whenever/tree/master">Whenever</a>。</p>




<p>Whenever可以让你写出类似下面的定时任务：
<pre name="code" class="ruby">
 set :cron_log, "/path/to/my/cron_log.log"</pre></p>




<p> every 2.hours do<br />
   command &#8220;/usr/bin/some_great_command&#8221;<br />
   runner &#8220;MyModel.some_method&#8221;<br />
   rake &#8220;some:great:rake:task&#8221;<br />
 end

赶快去Github看看文档和代码吧<a href="http://github.com/javan/whenever">http://github.com/javan/whenever</a></p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/13/%E5%9C%A8ror%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/13/feed-parser-in-ruby/">Feed Parser in Ruby</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-13 00:00:00 +0800" pubdate  updated >Nov 13<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p><blockquote>There are a number of ways of parsing an RSS feed in Ruby, but one of the best is a gem called <a href="http://github.com/pauldix/feedzirra/tree/master">Feedzirra</a>. The main advantage of Feedzirra is its speed; it parses feeds very quickly, but it is also useful as it can parse many different types of feed.
</blockquote></p>




<p>To install Feedzirra we first need to make sure that <code>http://gems.github.com</code> is in our list of gem sources. If not we’ll need to add it.
<pre>gem sources -a http://gems.github.com</pre>
Now we can install the gem:
<pre>sudo gem install pauldix-feedzirra</pre>
<strong><em>Notice:</em></strong> When I was installing the gem, there are several libs needed, including <em>libcurl4-gnutls-dev libcurl3-gnutls libxslt1-dev</em>, you may not meet this issue, it&#8217;s not a big deal, just install what it rely on. Several dependencies will also be installed alongside the gem. Once everything’s installed we’ll need to add a reference to the gem in our application’s <em>/config/environment.rb</em> file.
<pre>config.gem "pauldix-feedzirra", :lib =&gt; "feedzirra", :source =&gt; "http://gems.github.com"</pre>
That’s it. We’re ready to start parsing RSS feeds in our application.</p>




<p>Getting start:<br />
Assume that, you&#8217;ve got a model to store the feed content which is fetched by the parser, so the model should be like :
<pre name="code" class="ruby">
class FeedEntry < ActiveRecord::Base
  def self.update_from_feed(feed_url)
    feed = Feedzirra::Feed.fetch_and_parse(feed_url)
    add_entries(feed.entries)
  end</pre></p>

<p>  private<br />
  def self.add_entries(entries)<br />
    entries.each do |entry|<br />
      unless exists? :guid => entry.id<br />
        create!(<br />
          :name         => entry.title,<br />
          :summary      => entry.summary,<br />
          :url          => entry.url,<br />
          :published_at => entry.published,<br />
          :guid         => entry.id<br />
        )<br />
      end<br />
    end<br />
  end<br />
end

A more detailed manual is <a href="http://asciicasts.com/episodes/168-feed-parsing">here!</a></p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/13/feed-parser-in-ruby/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/12/primary_key-and-foreign_key-in-rails-association/">Primary_key and Foreign_key in Rails Association</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-12 00:00:00 +0800" pubdate  updated >Nov 12<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>The has_many and belongs_to association in Rails are with many optional parameters, they are actually the parameters for DB relationship, see more details by <a href="http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html">clicking here</a>.</p>




<p>As a reminder to myself, I misunderstood the primary_key an foreign_key conditions in association, it should be set in both sides in some case, for instance:
<pre name="code" class="ruby">
class Student < ActiveRecord::Base
  has_many :trial_lessons, :foreign_key => :user_id, :primary_key => :profile_id
end
</pre>
Above code will let you invoke the student.trial_lessons, but if you want to use trial_lesson.student, you have to define the association as below:
<pre name="code" class="ruby">
class TrialLesson < ActiveRecord::Base
  belongs_to :student, :primary_key => :profile_id, :foreign_key => :user_id
end
</pre>
<blockquote><strong>Notice that</strong>: you actually set the same :primary_key and :foreign_key in both sides, it&#8217;s because the DB relationship between these two Model can be described the same way..(it&#8217;s only a way for me to remember the rule)</blockquote></p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/12/primary_key-and-foreign_key-in-rails-association/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/11/solo/">什么都不是，是寂寞</a></h1>
    
    
      <p class="meta">




<time datetime="2009-11-11 00:00:00 +0800" pubdate  updated >Nov 11<span>th</span>, 2009</time>


</p>
    
  </header>


  <div class="entry-content"><p>其实再次决定坚持写Blog是因为不久前发现<a href="http://jonathanpalley.com/">JP的blog</a>和最近<a href="http://www.dujinfang.com">Seven哥Blog</a>积极的带动，所以我基本上打算打造一个以技术为主，扯淡为辅，学习为主，抒情几乎可以忽略到都谈不上为辅的Blog。</p>




<p>今天<a href="http://lijiapeng.com/">Buzz</a>看见我Blog的副标题调侃了一下我，我才突然明白一个道理：很多事情，都介于说了矫情和不说憋屈之间。所以那句“给寂寞，一个许诺。”就属于很靠近矫情的表达，坚决干掉，哈哈。并且我觉得Blog的名字也很罗嗦，干脆简化之：Refactoring Thoughts.</p>




<p>什么？Refactoring是什么意思？你不会Google啊。</p>

</div>
  <footer>
    <a rel="full-article" href="/2009/11/11/solo/">Read on &rarr;</a>
  </footer>


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page19/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
      <a class="next" href="/page17/">Newer &rarr;</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'andyspersonalblog';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <img src="http://farm8.staticflickr.com/7401/8772484013_a1af7dc483_o.jpg"></img>
  <p><b style="color:red">安迪</b><br />
     <b style="color:red">西安</b>, 中国 <br />
     <b style="color:red">自由职业</b> at <a href="http://intridea.com">Intridea</a></p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/12/06/31-years-old/">31岁了</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/01/xian-rubyists-on-trello/">如何用Trello组织西安Rubyists聚会</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/21/be-open-to-express-yourself/">从容表达</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/20/remote-working/">远程工作那些事儿</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/17/xian-rubyists-party-v2/">西安Rubyists线下活动通知[20130720]</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/07/on-the-road/">在路上</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/05/bookclub/">读书俱乐部</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/25/random-thoughts/">莫愁前路无知己</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>新浪微博</h1>
  <ul id="weibo">
    <li>
      <iframe 
        width="100%" 
        height="550" 
        class="share_self" 
        frameborder="0" 
        scrolling="no" 
        src="http://widget.weibo.com/weiboshow/index.php?width=0&height=550&ptype=1&speed=0&skin=&isTitle=0&noborder=1&isWeibo=1&isFans=&uid=1692318703&verifier=27e84cd9&dpc=1">
      </iframe>
    </li>
  </ul>
</section>


  
</aside>

    </div>
  </div>
  <footer><p>
  Copyright &copy; 2013 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
